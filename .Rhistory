left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * treated) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop))
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop))
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = count(year))
help mudate
?mutate
?group_by
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n())
ungroup()
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n()) %>%
ungroup()
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Keep years with mortality data
filter(year >= 2009) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n()) %>%
ungroup()
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Keep years with mortality data
filter(year >= 2009 & year <= 2017) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n()) %>%
ungroup()
df %>% group_by(ever_missing_flag) %>% summarise(n)
df %>% group_by(ever_missing_flag) %>% summarise(n())
df %>% filter(year == 2014) %>% group_by(ever_missing_flag) %>% summarise(n())
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Keep years with mortality data
filter(year >= 2009 & year <= 2017) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n()) %>%
ungroup() %>%
## Keep fips with no missing data
filter(ever_missing_flag == 0,
count_year == 9 )
df %>% filter(year == 2014) %>% group_by(state_abb, treated) %>% summarise(n())
## CLEAR ALL
rm(list = ls())
gc()
# --- Libraries ---
library(here)       # project-root relative paths
library(tidyverse)
library(data.table)
library(readr)      # data import
library(stringr)    # string helpers
# --- Project Metadata ---
project_name <- "synth_weights"
date_run     <- format(Sys.Date(), "%Y-%m-%d")
# --- File Paths (relative to Rproj root) ---
dir_data.      <- here("data")
dir_data_raw   <- "/Users/johniselin/Library/CloudStorage/Dropbox/sdid_weights/data/"
# --- Random Seed for Reproducibility ---
set.seed(56403)
# --- Parameters ---
start_year       <- 2009
end_year         <- 2017
## ACA Expansion states (First half of 2014)
aca <- c(4, 5, 6, 8, 9, 10, 11,	15, 17, 19, 21, 24, 25, 26, 27, 32, 34,
35, 36, 38, 39, 41, 44, 50, 53, 54)
## DROP AK IN, LA, MT, NH, and PA for later expansions (post first half of 2014)
drop <- c(2, 18, 22, 30, 33, 42)
## Mortality Data
## Imported via CDC Wonder on November 24, 2025
## All cause mortality, 20-64-year olds by county and year
## Load data
df_mortality <- read.csv(file = file.path(dir_data_raw,"cdc_wonder_data.csv"))
## Rename all to lower case
names(df_mortality) <- tolower(names(df_mortality))
## Clean Data
df_mortality <- df_mortality %>%
## Drop crude rate
select(-crude.rate, -year.code, -notes) %>%
## Tag counties with suppression
mutate(death_supp = ifelse(deaths == "Suppressed", 1,0),
death_miss = ifelse(deaths == "Missing", 1, 0),
pop_miss = ifelse(population == "Missing", 1, 0)) %>%
## Replace suppressed or missing values with 0
mutate(deaths = ifelse(deaths == "Suppressed", 0, deaths),
deaths = ifelse(deaths == "Missing", 0,deaths),
population = ifelse(population == "Missing", 0, population)) %>%
## Rename geographic vars
rename(fips = county.code) %>%
## Tag counties where population is ever 0
group_by(fips) %>%
mutate(ever_zero_flag = as.numeric(any(population == 0))) %>%
ungroup() %>%
## Convert deaths and population to numeric
mutate(deaths = as.numeric(deaths), population = as.numeric(population)) %>%
## Create mortality rate
mutate(crude_rate = (deaths / population) * 100000 ) %>%
## Select data
select(year, fips, crude_rate, deaths, population)
## Population data via https://seer.cancer.gov/popdata/download.html
## 1990-2020, 4 Expanded Races by Origin, All US
df_pop <- read_fwf(file = file.path(dir_data_raw,"covariates/us.1990_2020.19ages.adjusted.txt"),
fwf_widths( c(4, 2, 2, 3, 2, 1, 1, 1, 2, 8),
c("year", "state_abb", "state_fips", "county_fips",
"registry", "race", "hispanic", "sex", "age", "pop"))) %>%
filter(year >= 2007) %>% filter(year <= 2019) %>%
mutate(age = as.numeric(age), pop = as.numeric(pop)) %>%
select(-registry, -hispanic) %>%
group_by(year, state_abb, state_fips, county_fips, race, sex, age) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
mutate(fips = as.numeric(paste0(state_fips, county_fips)))
## Create relevant population samples
## Percent of population that is white
df_pop_race <- df_pop %>%
## Keep required variables
select(year, state_abb, state_fips, county_fips, fips, race, pop) %>%
## Group to get total pop by race
group_by(year, state_abb, state_fips, county_fips, race, fips) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
## Pivot to county X year level
pivot_wider(names_from = race, values_from = pop, values_fill = 0) %>%
## Rename by race
rename(white = '1', black = '2', aian = '3', asian = '4') %>%
## Fill-in missing values
replace_na(list(white = 0, black = 0, aian = 0, asian = 0)) %>%
## Create percent white
mutate(pct_white = white / (white + black + aian + asian)) %>%
select(year, fips, state_abb, state_fips, county_fips, pct_white) %>%
ungroup()
## Percent of the population that is elderly
df_pop_age <- df_pop %>%
## Keep required variables
select(year, state_abb, state_fips, county_fips, age, pop) %>%
## Group by to get totals by age
group_by(year, state_abb, state_fips, county_fips, age) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
## Pivot to get county X year level
pivot_wider(names_from = age, values_from = pop, values_fill = 0) %>%
## Rename variables
rename(pop_00 = '0', pop_01_04 = '1', pop_05_09 = '2',
pop_10_14 = '3', pop_15_19 = '4', pop_20_24 = '5',
pop_25_29 = '6', pop_30_34 = '7', pop_35_39 = '8',
pop_40_44 = '9', pop_45_49 = '10', pop_50_54 = '11',
pop_55_59 = '12', pop_60_64 = '13', pop_65_69 = '14',
pop_70_74 = '15', pop_75_79 = '16', pop_80_84 = '17',
pop_85 = '18' ) %>%
## Create summary variables
mutate(pop_total = rowSums(across(pop_00:pop_85)),
pop_20_64 = rowSums(across(pop_20_24:pop_20_24))) %>%
mutate(pct_55_64 = (pop_55_59 + pop_60_64)/ pop_total,
log_20_64 = log(rowSums(across(pop_20_24:pop_20_24))),
log_35_44 = log(rowSums(across(pop_35_39:pop_40_44)))) %>%
select(year, state_abb, state_fips, county_fips, pct_55_64, log_20_64, log_35_44, pop_20_64, pop_total) %>%
ungroup()
## By-age and gender statistics
df_pop_f_age <- df_pop %>%
## Keep if sex == 2
filter(sex == 2) %>%
## Keep required variables
select(year, state_abb, state_fips, county_fips, age, pop) %>%
## Group by to get totals by age
group_by(year, state_abb, state_fips, county_fips, age) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
## Pivot to get county X year level
pivot_wider(names_from = age, values_from = pop, values_fill = 0) %>%
rename(pop_00 = '0', pop_01_04 = '1', pop_05_09 = '2',
pop_10_14 = '3',  pop_15_19 = '4', pop_20_24 = '5',
pop_25_29 = '6', pop_30_34 = '7', pop_35_39 = '8',
pop_40_44 = '9', pop_45_49 = '10', pop_50_54 = '11',
pop_55_59 = '12', pop_60_64 = '13', pop_65_69 = '14',
pop_70_74 = '15', pop_75_79 = '16', pop_80_84 = '17',
pop_85 = '18' ) %>%
## Get summary variables
mutate(pop_total = rowSums(across(pop_00:pop_85))) %>%
mutate(log_f_20_64 = log(rowSums(across(pop_20_24:pop_60_64)))) %>%
select(year, state_abb, state_fips, county_fips, log_f_20_64) %>%
ungroup()
## Merge together population covariates
df_pop_cov <- df_pop_race %>%
full_join(df_pop_age,
by = join_by(year, state_abb, state_fips, county_fips)) %>%
left_join(df_pop_f_age,
by = join_by(year, state_abb, state_fips, county_fips)) %>%
select(year, fips, state_abb, state_fips, county_fips, pop_total, pct_white,
pop_20_64, pct_55_64, log_20_64, log_35_44, log_f_20_64)
## Unemployment data via https://download.bls.gov/pub/time.series/la/
## la.data.64.County
df_unempl <- read_tsv(file = file.path(dir_data_raw,"covariates/la.data.64.County")) %>%
## Keep year range
filter(year >= 2007, year <= 2019) %>%
select(-footnote_codes) %>%
mutate(series = as.numeric(substr(series_id, 19, 20)),
state_fips = substr(series_id, 6, 7),
county_fips = substr(series_id, 8, 10)) %>%
filter(series == 3) %>%
group_by(state_fips, county_fips, series_id, year) %>%
summarise(unemp = mean(value)) %>%
group_by() %>%
mutate(fips = as.numeric(paste0(state_fips, county_fips)),
state_fips = as.numeric(state_fips)) %>%
select(year, fips, unemp)
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Keep years with mortality data
filter(year >= 2009 & year <= 2017) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n()) %>%
ungroup() %>%
## Keep fips with no missing data
filter(ever_missing_flag == 0,
count_year == 9 )
## Determine state assignment
## Export version of data
write.csv(df,file = file.path(data,"analysis_data.csv"))
write.csv(df,file = file.path(dir_data,"analysis_data.csv"))
# =============================================================================
# Author: John Iselin and Erica Ryan
# Date:   November 24th, 2025
# File:   dataset_construction
#
# Project:  Dataset Construction for Borgschulte and Vogler (2020) replication
#           Construct County-Year panel from 2009 through 2017.
# =============================================================================
## CLEAR ALL
rm(list = ls())
gc()
# --- Libraries ---
library(here)       # project-root relative paths
library(tidyverse)
library(data.table)
library(readr)      # data import
library(stringr)    # string helpers
# --- Project Metadata ---
project_name <- "synth_weights"
date_run     <- format(Sys.Date(), "%Y-%m-%d")
# --- File Paths (relative to Rproj root) ---
dir_data     <- here("data")
dir_data_raw <- "/Users/johniselin/Library/CloudStorage/Dropbox/sdid_weights/data/"
# --- Random Seed for Reproducibility ---
set.seed(56403)
# --- Parameters ---
start_year       <- 2009
end_year         <- 2017
## ACA Expansion states (First half of 2014)
aca <- c(4, 5, 6, 8, 9, 10, 11,	15, 17, 19, 21, 24, 25, 26, 27, 32, 34,
35, 36, 38, 39, 41, 44, 50, 53, 54)
## DROP AK IN, LA, MT, NH, and PA for later expansions (post first half of 2014)
drop <- c(2, 18, 22, 30, 33, 42)
## Mortality Data
## Imported via CDC Wonder on November 24, 2025
## All cause mortality, 20-64-year olds by county and year
## Load data
df_mortality <- read.csv(file = file.path(dir_data_raw,"cdc_wonder_data.csv"))
## Rename all to lower case
names(df_mortality) <- tolower(names(df_mortality))
## Clean Data
df_mortality <- df_mortality %>%
## Drop crude rate
select(-crude.rate, -year.code, -notes) %>%
## Tag counties with suppression
mutate(death_supp = ifelse(deaths == "Suppressed", 1,0),
death_miss = ifelse(deaths == "Missing", 1, 0),
pop_miss = ifelse(population == "Missing", 1, 0)) %>%
## Replace suppressed or missing values with 0
mutate(deaths = ifelse(deaths == "Suppressed", 0, deaths),
deaths = ifelse(deaths == "Missing", 0,deaths),
population = ifelse(population == "Missing", 0, population)) %>%
## Rename geographic vars
rename(fips = county.code) %>%
## Tag counties where population is ever 0
group_by(fips) %>%
mutate(ever_zero_flag = as.numeric(any(population == 0))) %>%
ungroup() %>%
## Convert deaths and population to numeric
mutate(deaths = as.numeric(deaths), population = as.numeric(population)) %>%
## Create mortality rate
mutate(crude_rate = (deaths / population) * 100000 ) %>%
## Select data
select(year, fips, crude_rate, deaths, population)
## Population data via https://seer.cancer.gov/popdata/download.html
## 1990-2020, 4 Expanded Races by Origin, All US
df_pop <- read_fwf(file = file.path(dir_data_raw,"covariates/us.1990_2020.19ages.adjusted.txt"),
fwf_widths( c(4, 2, 2, 3, 2, 1, 1, 1, 2, 8),
c("year", "state_abb", "state_fips", "county_fips",
"registry", "race", "hispanic", "sex", "age", "pop"))) %>%
filter(year >= 2007) %>% filter(year <= 2019) %>%
mutate(age = as.numeric(age), pop = as.numeric(pop)) %>%
select(-registry, -hispanic) %>%
group_by(year, state_abb, state_fips, county_fips, race, sex, age) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
mutate(fips = as.numeric(paste0(state_fips, county_fips)))
## Create relevant population samples
## Percent of population that is white
df_pop_race <- df_pop %>%
## Keep required variables
select(year, state_abb, state_fips, county_fips, fips, race, pop) %>%
## Group to get total pop by race
group_by(year, state_abb, state_fips, county_fips, race, fips) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
## Pivot to county X year level
pivot_wider(names_from = race, values_from = pop, values_fill = 0) %>%
## Rename by race
rename(white = '1', black = '2', aian = '3', asian = '4') %>%
## Fill-in missing values
replace_na(list(white = 0, black = 0, aian = 0, asian = 0)) %>%
## Create percent white
mutate(pct_white = white / (white + black + aian + asian)) %>%
select(year, fips, state_abb, state_fips, county_fips, pct_white) %>%
ungroup()
## Percent of the population that is elderly
df_pop_age <- df_pop %>%
## Keep required variables
select(year, state_abb, state_fips, county_fips, age, pop) %>%
## Group by to get totals by age
group_by(year, state_abb, state_fips, county_fips, age) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
## Pivot to get county X year level
pivot_wider(names_from = age, values_from = pop, values_fill = 0) %>%
## Rename variables
rename(pop_00 = '0', pop_01_04 = '1', pop_05_09 = '2',
pop_10_14 = '3', pop_15_19 = '4', pop_20_24 = '5',
pop_25_29 = '6', pop_30_34 = '7', pop_35_39 = '8',
pop_40_44 = '9', pop_45_49 = '10', pop_50_54 = '11',
pop_55_59 = '12', pop_60_64 = '13', pop_65_69 = '14',
pop_70_74 = '15', pop_75_79 = '16', pop_80_84 = '17',
pop_85 = '18' ) %>%
## Create summary variables
mutate(pop_total = rowSums(across(pop_00:pop_85)),
pop_20_64 = rowSums(across(pop_20_24:pop_20_24))) %>%
mutate(pct_55_64 = (pop_55_59 + pop_60_64)/ pop_total,
log_20_64 = log(rowSums(across(pop_20_24:pop_20_24))),
log_35_44 = log(rowSums(across(pop_35_39:pop_40_44)))) %>%
select(year, state_abb, state_fips, county_fips, pct_55_64, log_20_64, log_35_44, pop_20_64, pop_total) %>%
ungroup()
## By-age and gender statistics
df_pop_f_age <- df_pop %>%
## Keep if sex == 2
filter(sex == 2) %>%
## Keep required variables
select(year, state_abb, state_fips, county_fips, age, pop) %>%
## Group by to get totals by age
group_by(year, state_abb, state_fips, county_fips, age) %>%
summarize(pop = sum(pop)) %>% group_by() %>%
## Pivot to get county X year level
pivot_wider(names_from = age, values_from = pop, values_fill = 0) %>%
rename(pop_00 = '0', pop_01_04 = '1', pop_05_09 = '2',
pop_10_14 = '3',  pop_15_19 = '4', pop_20_24 = '5',
pop_25_29 = '6', pop_30_34 = '7', pop_35_39 = '8',
pop_40_44 = '9', pop_45_49 = '10', pop_50_54 = '11',
pop_55_59 = '12', pop_60_64 = '13', pop_65_69 = '14',
pop_70_74 = '15', pop_75_79 = '16', pop_80_84 = '17',
pop_85 = '18' ) %>%
## Get summary variables
mutate(pop_total = rowSums(across(pop_00:pop_85))) %>%
mutate(log_f_20_64 = log(rowSums(across(pop_20_24:pop_60_64)))) %>%
select(year, state_abb, state_fips, county_fips, log_f_20_64) %>%
ungroup()
## Merge together population covariates
df_pop_cov <- df_pop_race %>%
full_join(df_pop_age,
by = join_by(year, state_abb, state_fips, county_fips)) %>%
left_join(df_pop_f_age,
by = join_by(year, state_abb, state_fips, county_fips)) %>%
select(year, fips, state_abb, state_fips, county_fips, pop_total, pct_white,
pop_20_64, pct_55_64, log_20_64, log_35_44, log_f_20_64)
## Unemployment data via https://download.bls.gov/pub/time.series/la/
## la.data.64.County
df_unempl <- read_tsv(file = file.path(dir_data_raw,"covariates/la.data.64.County")) %>%
## Keep year range
filter(year >= 2007, year <= 2019) %>%
select(-footnote_codes) %>%
mutate(series = as.numeric(substr(series_id, 19, 20)),
state_fips = substr(series_id, 6, 7),
county_fips = substr(series_id, 8, 10)) %>%
filter(series == 3) %>%
group_by(state_fips, county_fips, series_id, year) %>%
summarise(unemp = mean(value)) %>%
group_by() %>%
mutate(fips = as.numeric(paste0(state_fips, county_fips)),
state_fips = as.numeric(state_fips)) %>%
select(year, fips, unemp)
## Combine data
df <- df_pop_cov %>%
## Merge with Unemployment
left_join(df_unempl, join_by(year, fips)) %>%
## Merge with Mortality
left_join(df_mortality, join_by(year, fips)) %>%
## Assign ACA variables
mutate(expansion = ifelse(state_fips %in% aca,1, 0),
post = ifelse(year >= 2014,1,0)) %>%
mutate(treated = post * expansion) %>%
## Drop if in select states with odd ACA timing
filter(!(state_fips %in% drop)) %>%
## Keep years with mortality data
filter(year >= 2009 & year <= 2017) %>%
## Drop if missing mortality data
group_by(fips) %>%
mutate(ever_missing_flag = as.numeric(any(is.na(crude_rate))),
count_year = n()) %>%
ungroup() %>%
## Keep fips with no missing data
filter(ever_missing_flag == 0,
count_year == 9 )
## Determine state assignment
## Export version of data
write.csv(df,file = file.path(dir_data,"analysis_data.csv"))
rm(list = ls())
